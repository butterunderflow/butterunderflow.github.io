<!DOCTYPE html>
<html lang="cn" dir="auto">

<head><script src="/blog/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=blog/livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Partial Evaluation for Lambda Calculus | Butter&#39;s space</title>
<meta name="keywords" content="Partial-Evaluation, Abstrtact-Interpretation">
<meta name="description" content="这是 [1] 第 8 章 Partial Evaluation for Lambda Calculus 的笔记.
在 Partial Evaluation for Functional Language 和 Partial Evaluation For Flow Chart Langauge 中,
partial evaluation 所 eval 的东西很直观, 就是一个具体的像 int, bool 这样具体的值, 没有考虑高阶函数.
但是对于有高阶函数的语言, 情况变得复杂, 因为一个表达式的求值结果可能是一个函数,
那么考虑一个简单的场景, 返回一个常量的函数, 应该标记为是 Static 还是 Dynamic ?
比如: (lambda (x) 1)

如果标记为 S, 那这个函数在 residual program 中对应什么? 似乎也只能是 (lambda (x) 1)
如果标记为 D, 为什么一个这么简单的函数会返回一个常量的函数需要标记为 D?
是不是对于 lambda 表达式 partial evaluation 都无能为力?

我会有这样的疑惑主要有两个原因:

之前提到的 S 和 D 这样简单的 annotation 的标记对于简单的语言是足够的, 但是对于存在高阶函数的语言,
需要更丰富的 binding time annotation 才能描述&quot;编译期函数&quot;和&quot;运行时函数&quot;;
标记为 D 和 S 的表达式都不一定会出现在最终的 residual program 中, 在有高阶函数的语言,
residual program 长什么样主要看 partial evaluation 的结果,
之前的 &ldquo;Dynamic 表达式作为程序骨架, Static 表达式求值后嵌入程序骨架&rdquo; 的基本直觉失效了.

本文将介绍 lambda calculus 的 partial evaluation.
首先将定义一个简单的 lambda calculus, 然后介绍它的 binding time annotation 和 annotated version,
最后再分别展示它的 Binding Time Analysis(由 lambda calculus 得到 Annotated Program)和
具体的 staging(由 annotated program 得到 residual program)算法.">
<meta name="author" content="butterunderflow">
<link rel="canonical" href="http://localhost:1313/blog/articles/20231111153704-partial_evaluation_for_lambda_calculus/">
<link crossorigin="anonymous" href="/blog/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css" integrity="sha256-j&#43;ECM6cGvIfy4Is8&#43;XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/assets/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/assets/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/assets/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/assets/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/assets/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="cn" href="http://localhost:1313/blog/articles/20231111153704-partial_evaluation_for_lambda_calculus/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/blog/" accesskey="h" title="Butter&#39;s space (Alt + H)">Butter&#39;s space</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/blog/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/blog/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/blog/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/blog/demos/" title="Demos">
                    <span>Demos</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Partial Evaluation for Lambda Calculus
    </h1>
    <div class="post-meta"><span title='2024-03-02 00:00:00 +0000 UTC'>March 2, 2024</span>&nbsp;·&nbsp;butterunderflow

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#lambda-calculus-%e7%9a%84%e8%af%ad%e6%b3%95" aria-label="Lambda-calculus 的语法">Lambda-calculus 的语法</a></li>
                <li>
                    <a href="#binding-time-annotation--for-lambda-calculus" aria-label="Binding Time Annotation(for Lambda Calculus)">Binding Time Annotation(for Lambda Calculus)</a></li>
                <li>
                    <a href="#annotated-program--for-lambda-calculus" aria-label="Annotated Program(for Lambda Calculus)">Annotated Program(for Lambda Calculus)</a></li>
                <li>
                    <a href="#binding-time-analysis" aria-label="Binding Time Analysis">Binding Time Analysis</a><ul>
                        
                <li>
                    <a href="#naive-bta" aria-label="Naive BTA">Naive BTA</a></li>
                <li>
                    <a href="#naive-bta" aria-label="Naive BTA&#39;">Naive BTA'</a></li>
                <li>
                    <a href="#bta-by-type-check" aria-label="BTA by type check">BTA by type check</a></li></ul>
                </li>
                <li>
                    <a href="#staging" aria-label="Staging!">Staging!</a></li>
                <li>
                    <a href="#thinking" aria-label="thinking">thinking</a></li>
                <li>
                    <a href="#references" aria-label="References">References</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>这是 <a href="#citeproc_bib_item_1">[1]</a> 第 8 章 <em>Partial Evaluation for Lambda Calculus</em> 的笔记.</p>
<p>在 <a href="/blog/articles/partial-evaluation-for-functional/">Partial Evaluation for Functional Language</a> 和 <a href="/blog/articles/partial-evaluation-for-flow-chart/">Partial Evaluation For Flow Chart Langauge</a> 中,
partial evaluation 所 eval 的东西很直观, 就是一个具体的像 int, bool 这样具体的值, 没有考虑高阶函数.</p>
<p>但是对于有高阶函数的语言, 情况变得复杂, 因为一个表达式的求值结果可能是一个函数,
那么考虑一个简单的场景, 返回一个常量的函数, 应该标记为是 Static 还是 Dynamic ?
比如: <code>(lambda (x) 1)</code></p>
<ol>
<li>如果标记为 S, 那这个函数在 residual program 中对应什么? 似乎也只能是 <code>(lambda (x) 1)</code></li>
<li>如果标记为 D, 为什么一个这么简单的函数会返回一个常量的函数需要标记为 D?
是不是对于 lambda 表达式 partial evaluation 都无能为力?</li>
</ol>
<p>我会有这样的疑惑主要有两个原因:</p>
<ol>
<li>之前提到的 S 和 D 这样简单的 annotation 的标记对于简单的语言是足够的, 但是对于存在高阶函数的语言,
需要更丰富的 binding time annotation 才能描述&quot;编译期函数&quot;和&quot;运行时函数&quot;;</li>
<li>标记为 D 和 S 的表达式都不一定会出现在最终的 residual program 中, 在有高阶函数的语言,
residual program 长什么样主要看 partial evaluation 的结果,
之前的 &ldquo;Dynamic 表达式作为程序骨架, Static 表达式求值后嵌入程序骨架&rdquo; 的基本直觉失效了.</li>
</ol>
<p>本文将介绍 lambda calculus 的 partial evaluation.
首先将定义一个简单的 lambda calculus, 然后介绍它的 binding time annotation 和 annotated version,
最后再分别展示它的 Binding Time Analysis(由 lambda calculus 得到 Annotated Program)和
具体的 staging(由 annotated program 得到 residual program)算法.</p>
<ul>
<li>本文所有代码都将用 OCaml 演示, 代码仓库在 <a href="https://github.com/butterunderflow/lambda_pe">https://github.com/butterunderflow/lambda_pe</a> ,
可以在这里 <a href="https://butter-xz.com/lambda_pe/">https://butter-xz.com/lambda_pe/</a> 在线体验 Lambda Calculus 的 Partial Evaluation;</li>
<li>有时候 Lambda Calulus 会被简写成 LC, Partial Evaluation 会被简写为 PE,
Binding Time Analysis 会被简写为 BTA.</li>
</ul>
<h2 id="lambda-calculus-的语法">Lambda-calculus 的语法<a hidden class="anchor" aria-hidden="true" href="#lambda-calculus-的语法">#</a></h2>
<p>labmda 表达式的语法定义如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#75715e">(* expr1.ml, level 1 expression*)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> expr <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#a6e22e">EInt</span> <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#a6e22e">EVar</span> <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#a6e22e">ELam</span> <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">string</span> <span style="color:#f92672">*</span> expr
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#a6e22e">ELet</span> <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">string</span> <span style="color:#f92672">*</span> expr <span style="color:#f92672">*</span> expr
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#a6e22e">EApp</span> <span style="color:#66d9ef">of</span> expr <span style="color:#f92672">*</span> expr
</span></span></code></pre></div><h2 id="binding-time-annotation--for-lambda-calculus">Binding Time Annotation(for Lambda Calculus)<a hidden class="anchor" aria-hidden="true" href="#binding-time-annotation--for-lambda-calculus">#</a></h2>
<p>有 partial evaluation 的语言有个 two-level type system, two-level 的意思是,
一个 level 对应编程语言原来的类型系统, 另一个就对应这个 annotation.</p>
<p>在之前章节里关于 Binding Time Annotation 的一个比较直观的理解是:
标记为 S 会被 eval 成值, D 会在 residual program 中被保留成代码.</p>
<ul>
<li>这还是比较好理解的, 但是 <code>D -&gt; S</code> 呢? <code>D -&gt; S -&gt; S</code> &hellip; 呢? 它们代表什么?</li>
</ul>
<p>Binding time annotation 和一般的 type annotation 很类似,
只不过他不是描述 <strong><strong>运行时(run time)</strong></strong> 类型信息的, 而是描述 <strong><strong>partial evaluation time</strong></strong> 的类型信息的,
这个类型信息只做了 code 和 value 的区分, 具体的 code 和 value 又有它们自己在 first-level 的类型.</p>
<p>这个标记的所描述的是 pe-time 过程中的类型信息,
标记为 D(ynamic) 的表达式在 pe 过程中会被求值为 code, 标记为 S(tatic) 的会被求值为 value,
标记为 <code>D -&gt; S</code> 的表达式在 specialize 过程中会转换为由 code 到 value 函数,
但是它们并不代表 residual program 中的最终形态.
也就是说, 标记为 S 和 D 的表达式都不一定会出现在 residual program 中.</p>
<h2 id="annotated-program--for-lambda-calculus">Annotated Program(for Lambda Calculus)<a hidden class="anchor" aria-hidden="true" href="#annotated-program--for-lambda-calculus">#</a></h2>
<p>Annotated Program 对应一个语言的 Two-level syntax</p>
<figure>
    <img loading="lazy" src="/ox-hugo/2023-11-19_18-16-54_screenshot.png"
         alt="Figure 1: two-level syntax for Scheme0"/> <figcaption>
            <p><span class="figure-number">Figure 1: </span>two-level syntax for Scheme0</p>
        </figcaption>
</figure>

<figure>
    <img loading="lazy" src="/ox-hugo/2023-11-15_09-33-00_screenshot.png"
         alt="Figure 2: Lambda calculus 的 two-level syntax"/> <figcaption>
            <p><span class="figure-number">Figure 2: </span>Lambda calculus 的 two-level syntax</p>
        </figcaption>
</figure>

<p>带有 S 标记的表示这个表达式在 pe 过程中会 eval 到 value(可能是一般的值或函数值),
带有 D 标记的则会 eval 到 code.</p>
<ul>
<li>note: variable 没有标记, variable 的 pe 结果是从当前的 environment 中 lookup 的结果.</li>
</ul>
<!--listend-->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#75715e">(* expr2.ml, level 2 expression *)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> expr <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">(* use variable lookup as specialize result *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">Var</span> <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">(* specialize to a value(a pe time int or function value) *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">SConst</span> <span style="color:#66d9ef">of</span> constant
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">SLam</span> <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">string</span> <span style="color:#f92672">*</span> expr
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">SLet</span> <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">string</span> <span style="color:#f92672">*</span> expr <span style="color:#f92672">*</span> expr
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">SApp</span> <span style="color:#66d9ef">of</span> expr <span style="color:#f92672">*</span> expr
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">(* specialize to a pe-time code expression *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">DLam</span> <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">string</span> <span style="color:#f92672">*</span> expr
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">DLet</span> <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">string</span> <span style="color:#f92672">*</span> expr <span style="color:#f92672">*</span> expr
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">DApp</span> <span style="color:#66d9ef">of</span> expr <span style="color:#f92672">*</span> expr
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">DLift</span> <span style="color:#66d9ef">of</span> expr
</span></span><span style="display:flex;"><span><span style="color:#f92672">[@@</span>deriving sexp<span style="color:#f92672">]</span>
</span></span></code></pre></div><h2 id="binding-time-analysis">Binding Time Analysis<a hidden class="anchor" aria-hidden="true" href="#binding-time-analysis">#</a></h2>
<p>LC 的 Binding Time Analysis 就是把 LC 编译到 2LC 的过程, 我们可以这样定义 BTA 的接口:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">BTA_Sig</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">sig</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">val</span> analysis <span style="color:#f92672">:</span> Expr1.expr <span style="color:#f92672">-&gt;</span> Expr2.expr
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><h3 id="naive-bta">Naive BTA<a hidden class="anchor" aria-hidden="true" href="#naive-bta">#</a></h3>
<p>BTA 是一个比较泛的概念, 并没有唯一正确的做法, 比如说什么都不干,
把所有东西都当作 Dynamic 也是一种可行的 BTA:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> <span style="color:#a6e22e">NaiveBTA</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">BTA_Sig</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">struct</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">(* blindly push every thing to runtime *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> analysis <span style="color:#f92672">(</span>e <span style="color:#f92672">:</span> E1.expr<span style="color:#f92672">)</span> <span style="color:#f92672">:</span> E2.expr <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">rec</span> go e <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">match</span> e <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> E1.<span style="color:#a6e22e">EConst</span> c <span style="color:#f92672">-&gt;</span> E2.<span style="color:#a6e22e">SConst</span> c
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> E1.<span style="color:#a6e22e">EVar</span> x <span style="color:#f92672">-&gt;</span> E2.<span style="color:#a6e22e">Var</span> x
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> E1.<span style="color:#a6e22e">ELam</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> e0<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> E2.<span style="color:#a6e22e">DLam</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> go e0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> E1.<span style="color:#a6e22e">ELet</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> e0<span style="color:#f92672">,</span> e1<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> E2.<span style="color:#a6e22e">DLet</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> go e0<span style="color:#f92672">,</span> go e1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> E1.<span style="color:#a6e22e">EApp</span> <span style="color:#f92672">(</span>e0<span style="color:#f92672">,</span> e1<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> E2.<span style="color:#a6e22e">DApp</span> <span style="color:#f92672">(</span>go e0<span style="color:#f92672">,</span> go e1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>    go e
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><h3 id="naive-bta">Naive BTA'<a hidden class="anchor" aria-hidden="true" href="#naive-bta">#</a></h3>
<p>另一个极端是把所有东西都当作 static, 这么做当然也是可行的(只是没什么意义):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#75715e">(* blindly stage every thing to compile time *)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> analysis <span style="color:#f92672">(</span>e <span style="color:#f92672">:</span> E1.expr<span style="color:#f92672">)</span> <span style="color:#f92672">:</span> E2.expr <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">rec</span> go e <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">match</span> e <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> E1.<span style="color:#a6e22e">EConst</span> c <span style="color:#f92672">-&gt;</span> E2.<span style="color:#a6e22e">SConst</span> c
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> E1.<span style="color:#a6e22e">EVar</span> x <span style="color:#f92672">-&gt;</span> E2.<span style="color:#a6e22e">Var</span> x
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> E1.<span style="color:#a6e22e">ELam</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> e0<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> E2.<span style="color:#a6e22e">SLam</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> go e0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> E1.<span style="color:#a6e22e">ELet</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> e0<span style="color:#f92672">,</span> e1<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> E2.<span style="color:#a6e22e">SLet</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> go e0<span style="color:#f92672">,</span> go e1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> E1.<span style="color:#a6e22e">EApp</span> <span style="color:#f92672">(</span>e0<span style="color:#f92672">,</span> e1<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> E2.<span style="color:#a6e22e">SApp</span> <span style="color:#f92672">(</span>go e0<span style="color:#f92672">,</span> go e1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> E1.<span style="color:#a6e22e">EAnn</span> <span style="color:#f92672">(</span>e0<span style="color:#f92672">,</span> <span style="color:#f92672">_)</span> <span style="color:#f92672">-&gt;</span> go e0
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> E1.<span style="color:#a6e22e">EOp</span> <span style="color:#f92672">(</span>op<span style="color:#f92672">,</span> es<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> E2.<span style="color:#a6e22e">SOp</span> <span style="color:#f92672">(</span>op<span style="color:#f92672">,</span> List.map go es<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>  go e
</span></span></code></pre></div><h3 id="bta-by-type-check">BTA by type check<a hidden class="anchor" aria-hidden="true" href="#bta-by-type-check">#</a></h3>
<p>前面两个 NaiveBTA 是&quot;对&quot; 的吗? 当然是对的, 但是这其实没有意义, 因为我们没办法对 annotated program 做 staging
(staging nothing 和 staging everything).</p>
<p>前面提到了, BTA 的结果是不唯一的, 既然不唯一, 那要如何选择一个表达式的 annotation 呢?</p>
<p>比如说下面的代码, f 既 apply 到了 1(a static)上, 又 apply 到了 y(a dynamic)上, 如何确定 f 的 annotation?
很多种可行解.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> f <span style="color:#f92672">=</span> <span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x <span style="color:#66d9ef">in</span>  <span style="color:#75715e">(* f: D; D-&gt;D; S-&gt;S; (S-&gt;S) -&gt; (S-&gt;S) ... *)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span> f 1 <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span> f y <span style="color:#f92672">...</span> <span style="color:#75715e">(* y is dynamic *)</span>
</span></span></code></pre></div><p>如果我们只看 <code>f 1</code> , 那么 <code>f</code> 只能是 <code>S -&gt; 'a</code>, <code>D</code> , <code>D -&gt; 'a</code> (1可以被lift为Dynamic);
如果只看 <code>f y</code>, 那么 <code>f</code> 只能是 <code>D -&gt; 'a</code>, <code>D</code> .</p>
<p>书上介绍了一种约束收集+求解的方法, 定义了一个 annotation 上的偏序关系,
然后通过求解收集到的约束得到最小的解.</p>
<p>这个方法太复杂了, 一堆偏序关系头都要晕了, 如果有感兴趣的话可以看 <a href="#citeproc_bib_item_1">[1]</a> 的 <code>8.7 BTA by solving constraints</code> .</p>
<p>这里选择另一种简单点的方法作为实现.
首先, 为了让 bta 变得简单, 我们给 LC1 加上一个 binding time annotation 注解的语法,
让我们可以手动的为表达式添加 annotation.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#f92672">and</span> expr <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">EConst</span> <span style="color:#66d9ef">of</span> constant
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">EVar</span> <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">ELam</span> <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">string</span> <span style="color:#f92672">*</span> expr
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">ELet</span> <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">string</span> <span style="color:#f92672">*</span> expr <span style="color:#f92672">*</span> expr
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">EApp</span> <span style="color:#66d9ef">of</span> expr <span style="color:#f92672">*</span> expr
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">EAnn</span> <span style="color:#66d9ef">of</span> expr <span style="color:#f92672">*</span> Ann.t <span style="color:#75715e">(* Binding time annotation hint *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">EOp</span> <span style="color:#66d9ef">of</span> op <span style="color:#f92672">*</span> expr <span style="color:#66d9ef">list</span>
</span></span></code></pre></div><p>然后用 ML 类型推导的方式(不需要偏序关系, 仅仅需要等价关系)推导一个表达式的 Binding Time Annotation,
根据这个 Annotation 来得到 level 2 expression.</p>
<p>这里我们借用 <a href="/blog/articles/20230901095515-local_type_inference/">Local Type Inference</a> 中 bidirectional type checking 的思路,
把 bta 分为两种 mode:</p>
<ol>
<li>check mode: 已知一个表达式的 annotation <code>a</code>, 验证这个表达式的 annotation 是否等于 <code>a</code>;</li>
<li>infer mode: 对表达式的 annotation 一无所知, 需要推导这个表达式的 annotation.</li>
</ol>
<p>bidirectional type checking 可以把已经推导出的类型信息传递到相邻的语法树节点,
使得我们可以仅仅只写少量的 binding time annotation 注解就可以推导所有节点的 annotation.</p>
<p>具体的代码实现如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#66d9ef">rec</span> infer <span style="color:#f92672">(</span>e <span style="color:#f92672">:</span> E1.expr<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>env <span style="color:#f92672">:</span> ann_env<span style="color:#f92672">)</span> <span style="color:#f92672">:</span> E2.expr <span style="color:#f92672">*</span> ann <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">match</span> e <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> E1.<span style="color:#a6e22e">EConst</span> c <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">(</span>E2.<span style="color:#a6e22e">SConst</span> c<span style="color:#f92672">,</span> <span style="color:#a6e22e">S</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> E1.<span style="color:#a6e22e">EVar</span> x <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">(</span>E2.<span style="color:#a6e22e">Var</span> x<span style="color:#f92672">,</span> get x env<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> E1.<span style="color:#a6e22e">ELam</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> e0<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> failwith <span style="color:#e6db74">&#34;can&#39;t infer a lambda&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> E1.<span style="color:#a6e22e">ELet</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> e0<span style="color:#f92672">,</span> e1<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> e0&#39;<span style="color:#f92672">,</span> a0&#39; <span style="color:#f92672">=</span> infer e0 env <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">match</span> a0&#39; <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> <span style="color:#a6e22e">D</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">(</span>E2.<span style="color:#a6e22e">DLet</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> e0&#39;<span style="color:#f92672">,</span> check e1 Ann.<span style="color:#a6e22e">D</span> <span style="color:#f92672">((</span>x<span style="color:#f92672">,</span> a0&#39;<span style="color:#f92672">)</span> <span style="color:#f92672">::</span> env<span style="color:#f92672">)),</span> <span style="color:#a6e22e">D</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">let</span> e1&#39;<span style="color:#f92672">,</span> a1&#39; <span style="color:#f92672">=</span> infer e1 <span style="color:#f92672">((</span>x<span style="color:#f92672">,</span> a0&#39;<span style="color:#f92672">)</span> <span style="color:#f92672">::</span> env<span style="color:#f92672">)</span> <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">(</span>E2.<span style="color:#a6e22e">SLet</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> e0&#39;<span style="color:#f92672">,</span> e1&#39;<span style="color:#f92672">),</span> a1&#39;<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> E1.<span style="color:#a6e22e">EApp</span> <span style="color:#f92672">(</span>e0<span style="color:#f92672">,</span> e1<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> e0&#39;<span style="color:#f92672">,</span> a0&#39; <span style="color:#f92672">=</span> infer e0 env <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">match</span> a0&#39; <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> <span style="color:#a6e22e">S</span> <span style="color:#f92672">-&gt;</span> failwith <span style="color:#e6db74">&#34;error&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> <span style="color:#a6e22e">D</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">let</span> e1&#39; <span style="color:#f92672">=</span> check e1 Ann.<span style="color:#a6e22e">D</span> env <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">(</span>E2.<span style="color:#a6e22e">DApp</span> <span style="color:#f92672">(</span>e0&#39;<span style="color:#f92672">,</span> e1&#39;<span style="color:#f92672">),</span> Ann.<span style="color:#a6e22e">D</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> <span style="color:#a6e22e">Func</span> <span style="color:#f92672">(</span>arg_ann<span style="color:#f92672">,</span> ret_ann<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">let</span> e1&#39; <span style="color:#f92672">=</span> check e1 arg_ann env <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">(</span>E2.<span style="color:#a6e22e">SApp</span> <span style="color:#f92672">(</span>e0&#39;<span style="color:#f92672">,</span> e1&#39;<span style="color:#f92672">),</span> ret_ann<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> E1.<span style="color:#a6e22e">EAnn</span> <span style="color:#f92672">(</span>e0<span style="color:#f92672">,</span> a0<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">(</span>check e0 a0 env<span style="color:#f92672">,</span> a0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> E1.<span style="color:#a6e22e">EOp</span> <span style="color:#f92672">(</span>op<span style="color:#f92672">,</span> es<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">match</span> <span style="color:#f92672">(</span>op<span style="color:#f92672">,</span> es<span style="color:#f92672">)</span> <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> <span style="color:#a6e22e">OAdd</span><span style="color:#f92672">,</span> <span style="color:#f92672">[</span> e0<span style="color:#f92672">;</span> e1 <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> <span style="color:#a6e22e">OMinus</span><span style="color:#f92672">,</span> <span style="color:#f92672">[</span> e0<span style="color:#f92672">;</span> e1 <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> <span style="color:#a6e22e">OAnd</span><span style="color:#f92672">,</span> <span style="color:#f92672">[</span> e0<span style="color:#f92672">;</span> e1 <span style="color:#f92672">]</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">let</span> e0&#39;<span style="color:#f92672">,</span> a0&#39; <span style="color:#f92672">=</span> infer e0 env <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">let</span> e1&#39; <span style="color:#f92672">=</span> check e1 a0&#39; env <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">(</span>E2.<span style="color:#a6e22e">SOp</span> <span style="color:#f92672">(</span>op<span style="color:#f92672">,</span> <span style="color:#f92672">[</span> e0&#39;<span style="color:#f92672">;</span> e1&#39; <span style="color:#f92672">]),</span> a0&#39;<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> <span style="color:#a6e22e">ONot</span><span style="color:#f92672">,</span> <span style="color:#f92672">[</span> e0 <span style="color:#f92672">]</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">let</span> e0&#39;<span style="color:#f92672">,</span> a0&#39; <span style="color:#f92672">=</span> infer e0 env <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">(</span>E2.<span style="color:#a6e22e">SOp</span> <span style="color:#f92672">(</span>op<span style="color:#f92672">,</span> <span style="color:#f92672">[</span> e0&#39; <span style="color:#f92672">]),</span> <span style="color:#a6e22e">D</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> failwith <span style="color:#e6db74">&#34;neverreach&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">and</span> check <span style="color:#f92672">(</span>e <span style="color:#f92672">:</span> E1.expr<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>a <span style="color:#f92672">:</span> ann<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>env <span style="color:#f92672">:</span> ann_env<span style="color:#f92672">)</span> <span style="color:#f92672">:</span> E2.expr <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">match</span> e <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> E1.<span style="color:#a6e22e">ELam</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> e0<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> check_lambda x e0 a env
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> e&#39;<span style="color:#f92672">,</span> a&#39; <span style="color:#f92672">=</span> infer e env <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> a&#39; <span style="color:#f92672">=</span> a <span style="color:#66d9ef">then</span> e&#39;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> a&#39; <span style="color:#f92672">=</span> <span style="color:#a6e22e">S</span> <span style="color:#f92672">&amp;&amp;</span> a <span style="color:#f92672">=</span> <span style="color:#a6e22e">D</span> <span style="color:#66d9ef">then</span> E2.<span style="color:#a6e22e">DLift</span> e&#39;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span> failwith <span style="color:#e6db74">&#34;error&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">and</span> check_lambda x e a env <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">match</span> a <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">S</span> <span style="color:#f92672">-&gt;</span> failwith <span style="color:#e6db74">&#34;error lambda annotation&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">D</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> e&#39; <span style="color:#f92672">=</span> check e <span style="color:#a6e22e">D</span> <span style="color:#f92672">((</span>x<span style="color:#f92672">,</span> <span style="color:#a6e22e">D</span><span style="color:#f92672">)</span> <span style="color:#f92672">::</span> env<span style="color:#f92672">)</span> <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>      E2.<span style="color:#a6e22e">DLam</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> e&#39;<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">Func</span> <span style="color:#f92672">(</span>arg_ann<span style="color:#f92672">,</span> ret_ann<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> e&#39; <span style="color:#f92672">=</span> check e ret_ann <span style="color:#f92672">((</span>x<span style="color:#f92672">,</span> arg_ann<span style="color:#f92672">)</span> <span style="color:#f92672">::</span> env<span style="color:#f92672">)</span> <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>      E2.<span style="color:#a6e22e">SLam</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> e&#39;<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> analysis <span style="color:#f92672">(</span>e <span style="color:#f92672">:</span> E1.expr<span style="color:#f92672">)</span> <span style="color:#f92672">:</span> E2.expr <span style="color:#f92672">=</span> infer e empty_env <span style="color:#f92672">|&gt;</span> fst
</span></span></code></pre></div><h2 id="staging">Staging!<a hidden class="anchor" aria-hidden="true" href="#staging">#</a></h2>
<blockquote>
<p>万事俱备, 只欠 staging.</p></blockquote>
<p>LC 的 two-level syntax 类似于之前在 partial evaluation for Scheme0 提到的 <a href="/blog/articles/partial-evaluation-for-functional/#通过binding-time-annotation提高specialization算法的效率">Binding Time Annotation</a> ,
但是在值域上有所差异:</p>
<ol>
<li>Scheme0 的值域只能是 Constant 所在的值域(称之为 Const);</li>
<li>lambda calculus 的值域可以是高阶函数:
高阶函数的值域(2FuncVal)是很丰富的:
不仅可以是 \(Const \rightarrow Cosnt\) 的函数;
可以是 \(2FuncVal \rightarrow 2FuncVal\);
还可以是 \(Code\) &hellip; .</li>
</ol>
<p>在做完 BTA 后, staging 的实现就很简单了, LC2 的 staging 其实也可以看作 two-level lambda calculus(2LC)的 interpreter!
只是在值域上有所差异, 这个 2LC 的值域在 LC 的基础上加上了 Code,
对于 2LC 表达式的求值结果可能是:</p>
<ol>
<li>求值到 Const 或 FuncVal, 代表这个表达式已经求值完了;</li>
<li>还可能求值到一个 Code, 这个 Code 等之后再去算.</li>
</ol>
<p>dlambda 的 body 也必须求值到 code, 然后再通过 build-lambda 创建一个动态求知 lambda 表达式.
但是这里为什么要用 <code>newname</code>? 书上说是为了避免 confusion,
我理解这个完全是为了 residual program 可读性和 specialize 算法的可维护性考虑的, 就算不重命名也不会导致 bug.</p>
<p>staging的代码实现如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#66d9ef">rec</span> eval <span style="color:#f92672">(</span>e <span style="color:#f92672">:</span> expr<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>env <span style="color:#f92672">:</span> env<span style="color:#f92672">)</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">value</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">match</span> e <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#a6e22e">Var</span> x <span style="color:#f92672">-&gt;</span> List.assoc x env
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#a6e22e">DLam</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> e<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> new_var <span style="color:#f92672">=</span> gen_var <span style="color:#f92672">~</span>hint<span style="color:#f92672">:</span>x <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">VCode</span> <span style="color:#f92672">(</span>E1.<span style="color:#a6e22e">ELam</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> eval e <span style="color:#f92672">((</span>x<span style="color:#f92672">,</span> <span style="color:#a6e22e">VCode</span> new_var<span style="color:#f92672">)</span> <span style="color:#f92672">::</span> env<span style="color:#f92672">)</span> <span style="color:#f92672">|&gt;</span> get_code<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#a6e22e">DLet</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> e0<span style="color:#f92672">,</span> e1<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> updated_env <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> <span style="color:#a6e22e">VCode</span> <span style="color:#f92672">(</span>E1.<span style="color:#a6e22e">EVar</span> x<span style="color:#f92672">))</span> <span style="color:#f92672">::</span> env <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">VCode</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span><span style="color:#66d9ef">match</span> eval e0 env <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> <span style="color:#a6e22e">VCode</span> code <span style="color:#f92672">-&gt;</span> E1.<span style="color:#a6e22e">ELet</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> code<span style="color:#f92672">,</span> eval e1 updated_env <span style="color:#f92672">|&gt;</span> get_code<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> <span style="color:#a6e22e">VConst</span> c <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>          E1.<span style="color:#a6e22e">ELet</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> E1.<span style="color:#a6e22e">EConst</span> c<span style="color:#f92672">,</span> eval e1 updated_env <span style="color:#f92672">|&gt;</span> get_code<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> <span style="color:#a6e22e">VFun</span> f <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>          E1.<span style="color:#a6e22e">ELet</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">(</span> x<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>              f <span style="color:#f92672">(</span><span style="color:#a6e22e">VCode</span> <span style="color:#f92672">(</span>E1.<span style="color:#a6e22e">EVar</span> <span style="color:#e6db74">&#34;_x&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">|&gt;</span> get_code<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>              eval e1 updated_env <span style="color:#f92672">|&gt;</span> get_code <span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#a6e22e">DApp</span> <span style="color:#f92672">(</span>e0<span style="color:#f92672">,</span> e1<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">VCode</span> <span style="color:#f92672">(</span>E1.<span style="color:#a6e22e">EApp</span> <span style="color:#f92672">(</span>eval e0 env <span style="color:#f92672">|&gt;</span> get_code<span style="color:#f92672">,</span> eval e1 env <span style="color:#f92672">|&gt;</span> get_code<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#a6e22e">DLift</span> e <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> v <span style="color:#f92672">=</span> get_int <span style="color:#f92672">(</span>eval e env<span style="color:#f92672">)</span> <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">VCode</span> <span style="color:#f92672">(</span>E1.<span style="color:#a6e22e">EConst</span> v<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#a6e22e">SConst</span> c <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">VConst</span> c
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#a6e22e">SLam</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> e<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">VFun</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> v <span style="color:#f92672">-&gt;</span> eval e <span style="color:#f92672">((</span>x<span style="color:#f92672">,</span> v<span style="color:#f92672">)</span> <span style="color:#f92672">::</span> env<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#a6e22e">SLet</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> e0<span style="color:#f92672">,</span> e1<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> bind_value <span style="color:#f92672">=</span> eval e0 env <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>    eval e1 <span style="color:#f92672">((</span>x<span style="color:#f92672">,</span> bind_value<span style="color:#f92672">)</span> <span style="color:#f92672">::</span> env<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#a6e22e">SApp</span> <span style="color:#f92672">(</span>e0<span style="color:#f92672">,</span> e1<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> func <span style="color:#f92672">=</span> get_func <span style="color:#f92672">(</span>eval e0 env<span style="color:#f92672">)</span> <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>    eval e1 env <span style="color:#f92672">|&gt;</span> func
</span></span></code></pre></div><h2 id="thinking">thinking<a hidden class="anchor" aria-hidden="true" href="#thinking">#</a></h2>
<p>Offline PE 中 annotated language(比如 2LC) 和 typeset language 的是否会存在某种同构?</p>
<h2 id="references">References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h2>
<style>.csl-left-margin{float: left; padding-right: 0em;}
 .csl-right-inline{margin: 0 0 0 1em;}</style><div class="csl-bib-body">
  <div class="csl-entry"><a id="citeproc_bib_item_1"></a>
    <div class="csl-left-margin">[1]</div><div class="csl-right-inline">N. D. Jones, C. K. Gomard, and P. Sestoft, <i>Partial Evaluation and Automatic Program Generation</i>. USA: Prentice-Hall, Inc., 1993.</div>
  </div>
</div>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/blog/tags/partial-evaluation/">Partial-Evaluation</a></li>
      <li><a href="http://localhost:1313/blog/tags/abstrtact-interpretation/">Abstrtact-Interpretation</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2025 <a href="http://localhost:1313/blog/">Butter&#39;s space</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>


<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>

</html>
